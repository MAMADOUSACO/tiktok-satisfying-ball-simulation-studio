<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bouncing Balls ‚Äì Blockly Rule Editor</title>
  
  <!-- External Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/seedrandom@3.0.5/seedrandom.min.js"></script>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  
  <!-- Project Styles -->
  <link rel="stylesheet" href="css/styles.css">
  
  <style>
    /* Additional styles for frame stepping controls */
    .step-controls {
      display: grid;
      gap: 6px;
      margin-top: 8px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.01);
    }
    
    .step-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .step-button {
      background: linear-gradient(180deg, #1a3a5e, #0f274d);
      border-color: #2d4972;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 11px;
      min-width: 60px;
    }
    
    .step-button:hover:not(:disabled) {
      border-color: #3a5f85;
      background: linear-gradient(180deg, #1f4066, #14304f);
    }
    
    .step-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .step-mode-active {
      background: linear-gradient(180deg, #0e4d2b, #0a3d22) !important;
      border-color: #1a5d35 !important;
      color: var(--ok) !important;
    }
    
    .step-mode-active:hover {
      border-color: #2a7d45 !important;
    }
    
    .frame-display {
      background: #0c1220;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      text-align: center;
      min-width: 60px;
    }
    
    .continuous-mode {
      color: var(--accent);
    }
    
    .step-mode {
      color: var(--ok);
      font-weight: 600;
    }
    
    .keyboard-hints {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>Bouncing Balls <span class="sub">‚Äî deterministic, block rules</span></h1>
    <div class="col" style="gap:12px">
      <div class="group col">
        <div class="row" style="justify-content:space-between">
          <div class="tag">FPS: <span id="fps" class="kpi">0</span></div>
          <div class="tag">Balls: <span id="ballCount" class="kpi">0</span></div>
        </div>
        <div class="row" style="gap:6px;flex-wrap:wrap;margin-top:6px">
          <button id="btnRun" class="primary">Run</button>
          <button id="btnPause">Pause</button>
          <button id="btnReset" class="warn">Reset</button>
        </div>
        <div id="warnBanner" class="banner"></div>
      </div>

      <div class="group col">
        <label>üéÆ Frame Stepping Control</label>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="tag">Frame: <span id="frameCount" class="kpi">0</span></div>
          <div class="tag">Mode: <span id="simulationMode" class="kpi continuous-mode">continuous</span></div>
        </div>
        
        <div class="step-controls">
          <div class="step-row">
            <button id="btnStepBack" class="step-button" title="Step backward (Left Arrow)">‚èÆÔ∏è Back</button>
            <button id="btnStepForward" class="step-button" title="Step forward (Right Arrow)">‚è≠Ô∏è Forward</button>
            <select id="stepSizeSelect" style="flex:1;font-size:11px;padding:4px">
              <option value="1">1 frame</option>
              <option value="5">5 frames</option>
              <option value="10">10 frames</option>
              <option value="30">30 frames</option>
              <option value="60">60 frames</option>
            </select>
          </div>
          
          <div class="step-row">
            <button id="btnToggleMode" class="step-button" style="flex:1" title="Toggle mode (Ctrl+S)">Switch to Step Mode</button>
            <button id="btnResetFrame" class="step-button warn" title="Reset frame counter (Ctrl+R)">üîÑ Reset</button>
          </div>
          
          <div class="step-row">
            <button onclick="window.showHistoryStats()" class="step-button" style="flex:1;font-size:10px" title="Show frame buffer debug info">üìä Debug Info</button>
          </div>
          
          <div class="keyboard-hints">
            <strong>Shortcuts:</strong> Space (step/play), ‚Üê ‚Üí (step), Shift+‚Üê ‚Üí (√ó10), Ctrl+S (mode), Ctrl+R (reset)
          </div>
        </div>
      </div>

      <div class="group col">
        <label for="seed">Seed</label>
        <div class="row" style="gap:6px">
          <input id="seed" type="text" placeholder="e.g., tornado-42" value="tornado-42" />
          <button id="btnReseed">üé≤</button>
        </div>
        <div class="row" style="gap:6px">
          <label style="min-width:120px">Initial balls</label>
          <input id="initialBalls" type="number" min="0" max="2000" value="12" style="max-width:120px"/>
          <button id="btnSpawnInit">Spawn</button>
        </div>
        <div class="row" style="gap:6px"><label style="min-width:120px">Enable collisions</label><input id="chkCollide" type="checkbox" /></div>
        <div class="row" style="gap:6px"><label style="min-width:120px">Trail fade</label><input id="chkTrail" type="checkbox" checked /></div>
        <div class="row" style="gap:6px"><label style="min-width:120px">Wall SFX</label><input id="chkSfx" type="checkbox" /></div>
      </div>

      <div class="group col">
        <label>Physics Engine</label>
        <div class="row" style="gap:6px">
          <select id="physicsSelect" style="flex:1">
            <option value="arcadeSimple">Arcade Simple (No Energy Transfer)</option>
            <option value="arcade">Arcade (Perfect Bouncing)</option>
            <option value="realistic">Realistic (Gravity + Energy Loss)</option>
          </select>
        </div>
        
        <div id="arcadeSettings" class="physics-settings">
          <div class="option-row">
            <label>Min Angle:</label>
            <input id="arcadeMinAngle" type="number" min="5" max="45" value="15" step="1">
            <span style="font-size:10px">¬∞</span>
          </div>
          <div class="option-row">
            <label>Max Angle:</label>
            <input id="arcadeMaxAngle" type="number" min="120" max="175" value="165" step="1">
            <span style="font-size:10px">¬∞</span>
          </div>
        </div>
        
        <div id="realisticSettings" class="physics-settings" style="display:none">
          <div class="option-row">
            <label>Gravity:</label>
            <input id="realisticGravity" type="number" min="0" max="2000" value="980" step="50">
          </div>
          <div class="option-row">
            <label>Bounce:</label>
            <input id="realisticElasticity" type="number" min="0.1" max="1.0" value="0.85" step="0.05">
          </div>
          <div class="option-row">
            <label>Air Drag:</label>
            <input id="realisticAirResistance" type="number" min="0.9" max="1.0" value="0.99" step="0.01">
          </div>
        </div>
        
        <small class="sub">Simple = no momentum transfer, Arcade = elastic collisions, Realistic = natural settling</small>
      </div>

      <div class="group col">
        <div class="row" style="gap:6px;flex-wrap:wrap">
          <button id="btnApply" class="primary">Apply Program</button>
          <button id="btnExportXml">Save Blocks</button>
          <button id="btnImportXml">Load Blocks</button>
          <button id="btnTests">Run Tests</button>
        </div>
        <div class="row" style="gap:6px;margin-top:6px">
          <select id="presetSelect" style="flex:1">
            <option value="">‚Äî Load sample program ‚Äî</option>
            <option value="duplicate">Duplicate on wall hit</option>
            <option value="grow">Grow + color-shift on wall hit</option>
            <option value="trail">Fade trail on tick</option>
            <option value="escape">Score when exiting gap</option>
            <option value="collision">Collision destroys & colors (NEW)</option>
            <option value="spawn_chain">Chain spawn effects (NEW)</option>
          </select>
          <button id="btnLoadPreset">Load</button>
        </div>
      </div>

      <div class="group col">
        <div class="row" style="gap:6px;flex-wrap:wrap">
          <button id="btnRecord">Start Recording</button>
          <button id="btnAutoRecord">Auto-record: OFF</button>
          <a id="downloadLink" style="display:none"></a>
        </div>
        
        <div class="recording-options">
          <label>Recording Options</label>
          <div class="option-row">
            <label>Format:</label>
            <select id="recordFormat">
              <option value="webm">WebM</option>
              <option value="mp4">MP4 (if supported)</option>
            </select>
          </div>
          <div class="option-row">
            <label>FPS:</label>
            <select id="recordFps">
              <option value="15">15</option>
              <option value="24">24</option>
              <option value="30" selected>30</option>
              <option value="60">60</option>
            </select>
          </div>
          <div class="option-row">
            <label>Quality:</label>
            <select id="recordQuality">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="ultra">Ultra</option>
            </select>
          </div>
          <div class="option-row">
            <label>Bitrate:</label>
            <input id="recordBitrate" type="number" min="500" max="50000" value="5000" step="500" placeholder="kbps">
          </div>
        </div>
        
        <small class="sub">Records directly from canvas. Format/quality support varies by browser.</small>
      </div>

      <div class="group col">
        <label>‚ú® Draggable Parameters Tips</label>
        <ul style="margin:6px 0 0 16px;padding:0;color:var(--muted);font-size:12px">
          <li><strong>Hold & drag</strong> purple ball tokens from event blocks</li>
          <li>Drop on action blocks for <strong>auto-connection</strong></li>
          <li>Green highlighting shows valid drop zones</li>
          <li>Drop in empty space creates standalone parameter</li>
          <li>Visual data flow like Scratch programming!</li>
        </ul>
      </div>

      <div class="group col">
        <label>üéÆ Frame Stepping Tips</label>
        <ul style="margin:6px 0 0 16px;padding:0;color:var(--muted);font-size:12px">
          <li><strong>Step Mode:</strong> Precise frame-by-frame control</li>
          <li><strong>Continuous Mode:</strong> Normal real-time animation</li>
          <li>Step backward uses saved simulation states (5000 frames)</li>
          <li>Perfect for debugging physics behaviors</li>
          <li>Use step size selector for faster navigation</li>
        </ul>
      </div>

      <div class="group col">
        <label>‚öôÔ∏è Physics Modes</label>
        <ul style="margin:6px 0 0 16px;padding:0;color:var(--muted);font-size:12px">
          <li><strong>Arcade Simple:</strong> No momentum transfer, balls keep speed</li>
          <li><strong>Arcade:</strong> Elastic collisions with perfect energy conservation</li>
          <li><strong>Realistic:</strong> Gravity, air resistance, energy loss</li>
          <li>Wall angle constraints apply to all arcade modes</li>
          <li>Perfect for different simulation styles</li>
        </ul>
      </div>

      <div class="group col">
        <label>General Tips</label>
        <ul style="margin:6px 0 0 16px;padding:0;color:var(--muted);font-size:12px">
          <li>Click <em>Apply Program</em> after editing blocks.</li>
          <li>Seed keeps runs repeatable.</li>
          <li>Trail fade is a render effect; physics is unchanged.</li>
          <li>Collisions are basic (equal mass, elastic).</li>
          <li>Drag the divider to resize panels.</li>
        </ul>
      </div>
    </div>
  </aside>

  <main class="canvas-wrap">
    <div class="canvas-shell">
      <canvas id="sim" width="1080" height="1920"></canvas>
      <div class="ring"></div>
      <div class="footer"><span class="tag">1080√ó1920 ‚Ä¢ 9:16</span></div>
    </div>
  </main>

  <div class="resize-handle" id="resizeHandle"></div>

  <aside class="right">
    <div class="row" style="justify-content:space-between;align-items:center;padding:4px 8px">
      <strong>Rule Editor</strong>
      <span class="tag">‚ú® Enhanced with Draggable Parameters & Frame Stepping</span>
    </div>
    <div id="blocklyDiv"></div>
  </aside>

  <!-- Enhanced Toolbox XML with Parameter Support -->
  <xml id="toolbox" style="display:none">
    <category name="Events" colour="#5CA699">
      <block type="event_tick"></block>
      <block type="event_wall_hit">
        <field name="PARAM_BALL">ball</field>
      </block>
      <block type="event_ball_collision">
        <field name="PARAM_BALL1">ball1</field>
        <field name="PARAM_BALL2">ball2</field>
      </block>
      <block type="event_spawn">
        <field name="PARAM_BALL">newBall</field>
      </block>
      <block type="event_exit">
        <field name="PARAM_BALL">ball</field>
      </block>
    </category>
    <category name="Actions" colour="#5C81A6">
      <block type="action_spawn">
        <field name="N">1</field>
        <value name="R">
          <shadow type="math_number">
            <field name="NUM">15</field>
          </shadow>
        </value>
      </block>
      <block type="action_duplicate"></block>
      <block type="action_destroy"></block>
      <block type="action_set_velocity">
        <value name="VX">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
        <value name="VY">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="action_scale_speed">
        <value name="F">
          <shadow type="math_number">
            <field name="NUM">1.1</field>
          </shadow>
        </value>
      </block>
      <block type="action_set_radius">
        <value name="R">
          <shadow type="math_number">
            <field name="NUM">15</field>
          </shadow>
        </value>
      </block>
      <block type="action_set_color">
        <value name="C">
          <shadow type="text">
            <field name="TEXT">#ff0000</field>
          </shadow>
        </value>
      </block>
      <block type="action_log">
        <value name="MSG">
          <shadow type="text">
            <field name="TEXT">Hello!</field>
          </shadow>
        </value>
      </block>
      <block type="action_score">
        <value name="D">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="Ball" colour="#A6745C">
      <block type="ball_get">
        <field name="K">x</field>
      </block>
      <block type="ball_set">
        <field name="K">x</field>
        <value name="V">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="parameter_get">
        <field name="PARAM_NAME">ball</field>
      </block>
    </category>
    <category name="Logic" colour="#5C68A6">
      <block type="controls_if"></block>
      <block type="logic_compare">
        <field name="OP">EQ</field>
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="logic_boolean">
        <field name="BOOL">TRUE</field>
      </block>
      <block type="logic_negate">
        <value name="BOOL">
          <shadow type="logic_boolean">
            <field name="BOOL">TRUE</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="Loops" colour="#5CA65C">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="#A65C81">
      <block type="math_number">
        <field name="NUM">10</field>
      </block>
      <block type="math_arithmetic">
        <field name="OP">ADD</field>
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.14</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <field name="OP">ROOT</field>
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <field name="OP">SIN</field>
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="util_rand"></block>
      <block type="util_map">
        <value name="X">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
        <value name="C">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
        <value name="D">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="Text" colour="#5CA68D">
      <block type="text"></block>
      <block type="text_join"></block>
    </category>
    <category name="Variables" custom="VARIABLE" colour="#A6745C"></category>
  </xml>

  <!-- Project Scripts -->
  <script src="js/utils.js"></script>
  <script src="js/physics.js"></script>
  <script src="js/blocks.js"></script>
  <script src="js/presets.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/main.js"></script>
</body>
</html>